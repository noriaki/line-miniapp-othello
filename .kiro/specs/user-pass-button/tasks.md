# 実装タスク

## 実装タスク一覧

- [x] 1. パス機能の状態管理基盤を構築する
- [x] 1.1 useGameStateフックに連続パスカウンタを追加する
  - `consecutivePassCount`状態を追加し、初期値を0に設定する
  - `incrementPassCount`メソッドを実装し、カウンタを1増加させる
  - `resetPassCount`メソッドを実装し、カウンタを0にリセットする
  - `resetGame`メソッド内で`consecutivePassCount`を0にリセットする処理を追加する
  - カウンタが常に0以上2以下の範囲に収まることを保証する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 1.2 パス操作通知機能を追加する
  - **[削除]** 既存の未使用スキップ通知機能を削除する
    - `useGameErrorHandler`から`skipNotification`状態を削除する
    - `notifyTurnSkip()`メソッドを削除する
    - `getSkipMessage()`メソッドを削除する
    - `skipNotificationTimerRef`を削除する
    - スキップ通知関連のテストコード（`useGameErrorHandler.test.ts`）を削除する
  - **[追加]** パス通知機能を実装する
    - `useGameErrorHandler`フックに`passNotification`状態を追加する
    - `notifyPass(player: Player)`メソッドを追加する
    - `getPassMessage()`メソッドを追加する
    - ユーザのパス時に「有効な手がありません。パスしました。」というメッセージを設定する
    - AIのパス時に「AIに有効な手がありません。AIがパスしました。」というメッセージを設定する
    - 既存の通知UIエリアに通知メッセージを表示する
    - 通知は3秒後に自動クリアする
  - _Requirements: 3.3_
  - _Design Review Issue 1: スキップ通知廃止、パス通知に統一_

- [x] 2. パスボタンUIを実装する
- [x] 2.1 パスボタンコンポーネントをGameBoardに統合する
  - GameBoard.tsxの`board-grid`直後、`game-result`の前にパスボタン要素を配置する
  - ボタンに「パス」というラベルテキストを表示する
  - ボタンを中央揃えで配置し、最小タッチターゲットサイズを44x44pxに設定する
  - `aria-label`属性に「ターンをパスする」を設定する
  - `aria-disabled`属性をボタンの有効/無効状態に連動させる
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 6.1, 6.2, 6.4_

- [x] 2.2 パスボタンのスタイリングを実装する
  - GameBoard.cssにパスボタン用のCSSクラスを追加する
  - 有効状態のスタイル(通常の色・透明度)を定義する
  - 無効状態のスタイル(グレーアウトまたは低透明度)を定義する
  - フォーカスインジケータのスタイルを追加する
  - Tailwind CSSユーティリティクラスと組み合わせてレスポンシブ対応する
  - _Requirements: 2.3, 2.4, 6.3_

- [x] 3. パス操作ロジックを実装する
- [x] 3.1 ユーザのパス操作ハンドラを実装する
  - GameBoard.tsx内に`handlePass`関数を作成する
  - 現在のゲーム状態が`playing`であることを検証する
  - 有効な手が存在しない(`validMoves.length === 0`)ことを検証する
  - `incrementPassCount`を呼び出して連続パスカウンタを増加させる
  - `switchPlayer`を呼び出して相手プレイヤーにターンを切り替える
  - パス通知メッセージを表示する
  - ターンカウントを1増加させる
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 5.1_

- [x] 3.2 パスボタンの有効化条件を実装する
  - `validMoves.length === 0`の場合にパスボタンを有効化する
  - 現在のプレイヤーがユーザ(`currentPlayer === 'black'`)の場合のみ有効化する
  - ゲーム状態が`playing`の場合のみ有効化する
  - AIのターン時はパスボタンを無効化する
  - ボタンの有効/無効状態を視覚的に表現する
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 3.3 有効な手実行時のパスカウンタリセットを実装する
  - 既存の`handleCellClick`関数内で、有効な手が実行された後に`resetPassCount`を呼び出す
  - AIターンハンドラ内で、AIが有効な手を実行した後に`resetPassCount`を呼び出す
  - カウンタリセットにより連続パス検出が正しく機能することを保証する
  - _Requirements: 5.4_

- [x] 4. AI自動パス処理を実装する
- [x] 4.1 AIターン時のパス判定と通知タイミング制御を追加する
  - GameBoard.tsxのAIターンハンドラ(`useEffect`)内で、AIの有効な手をチェックする
  - `validMoves.length === 0`の場合、AIのWASM計算をスキップする
  - 有効な手が存在しない場合、以下の順序でAI自動パスを実行する:
    1. `setAIThinking(true)` でAI思考インジケータを表示
    2. `handlePass()` を呼び出してパス処理を実行
    3. `notifyPass('white')` でパス通知「AIに有効な手がありません。AIがパスしました。」を表示
    4. 1秒待機（`setTimeout` または `async/await`）
    5. `switchPlayer()` でプレイヤーを切り替え
    6. `setAIThinking(false)` でAI思考インジケータを非表示
  - ユーザーがAIのパスを認識できるよう、視覚的フィードバックとタイミング制御を実装する
  - _Requirements: 4.2, 4.3_
  - _Design Review Issue 2: AI自動パス時のユーザー通知タイミング改善_

- [x] 4.2 連続パス検出、ゲーム終了処理、エッジケース処理を実装する
  - パス操作後、`consecutivePassCount`が2に達したかチェックする
  - 連続パスが発生した場合、`checkGameEnd`関数を呼び出す
  - ゲーム状態を`finished`に遷移させる
  - 現在の石数で勝敗を判定する
  - ゲーム結果を表示する
  - **[エッジケース処理]** 以下のシナリオに対応する:
    - `resetGame()`実行時に`consecutivePassCount`を0にリセットする処理を明示的に実装
    - パスボタン連打防止: パス処理中は`handlePass()`の再実行をブロック（フラグまたは`isAIThinking`を利用）
    - ゲーム終了処理中（`consecutivePassCount === 2`到達後）のユーザー操作をブロック
    - `gameStatus`が`'playing'`でない場合、パス操作を中止する
  - _Requirements: 4.1, 4.4, 5.3_
  - _Design Review Issue 3: 連続パス検出ロジックのエッジケース処理追加_

- [x] 5. エラーハンドリングを実装する
- [x] 5.1 無効なパス操作のエラー処理を追加する
  - `validMoves.length > 0`の場合、パス操作を無視する
  - コンソールに警告ログを出力する
  - ユーザには何も表示せず、操作を無視する(UIが既に無効状態を示している)
  - _Requirements: 7.3_

- [x] 5.2 ゲーム状態不整合のエラー処理を追加する
  - `gameStatus.type !== 'playing'`の場合、パス操作を中止する
  - エラー詳細をコンソールに記録する
  - ユーザにエラーメッセージを表示する
  - ゲーム状態を変更しない
  - _Requirements: 7.1, 7.2_

- [x] 5.3 連続パスカウンタの範囲検証を追加する
  - `consecutivePassCount`が0未満または2超過の場合、エラーログを記録する
  - カウンタを自動的に安全な値(0)にリセットする
  - ゲームは継続可能な状態を維持する
  - _Requirements: 7.4_

- [ ] 6. パス機能のユニットテストを実装する
- [ ] 6.1 useGameState拡張のテストを追加する
  - `incrementPassCount`がカウンタを1増加させることをテストする
  - `resetPassCount`がカウンタを0にリセットすることをテストする
  - `resetGame`実行時にカウンタが0にリセットされることをテストする
  - カウンタが0以上2以下の範囲に収まることをテストする
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 6.2 パス操作ハンドラのロジックをテストする
  - `handlePass`が`incrementPassCount`を呼び出すことをテストする
  - 有効な手が存在する場合、パス操作が実行されないことをテストする
  - ゲーム状態が`playing`でない場合、パス操作が中止されることをテストする
  - パス実行後、プレイヤーが切り替わることをテストする
  - _Requirements: 3.1, 3.2, 7.1, 7.3_

- [ ] 6.3 連続パス検出のテストを追加する
  - `consecutivePassCount === 2`の場合、ゲーム終了判定が実行されることをテストする
  - ゲーム状態が`finished`に遷移することをテストする
  - 連続パス後の勝敗判定が正しく実行されることをテストする
  - _Requirements: 4.1, 4.4, 5.3_

- [ ] 6.4 パスカウンタリセットのテストを追加する
  - 有効な手が実行された後、カウンタが0にリセットされることをテストする
  - ユーザとAIのどちらが手を実行してもリセットされることをテストする
  - _Requirements: 5.4_

- [ ] 7. パス機能の統合テストを実装する
- [ ] 7.1 ユーザパスフローの統合テストを追加する
  - ユーザがパスし、次のターンがAIに切り替わることをテストする
  - パス通知メッセージが表示されることをテストする
  - `consecutivePassCount`が正しく増加することをテストする
  - _Requirements: 3.1, 3.3, 3.4, 5.1_

- [ ] 7.2 AI自動パスフローの統合テストを追加する
  - AIが有効な手がない場合、自動的にパスすることをテストする
  - AI通知メッセージが表示されることをテストする
  - パス後にユーザのターンに切り替わることをテストする
  - _Requirements: 4.2, 4.3_

- [ ] 7.3 連続パス後のゲーム終了フローをテストする
  - ユーザとAIが連続してパスした場合、ゲームが終了することをテストする
  - `consecutivePassCount`が2に達することをテストする
  - ゲーム結果が正しく表示されることをテストする
  - _Requirements: 4.1, 4.4, 5.3_

- [ ] 7.4 パスカウンタリセットフローの統合テストを追加する
  - パス後に有効な手が実行されると、カウンタがリセットされることをテストする
  - ゲームリセット時にカウンタが0になることをテストする
  - _Requirements: 5.4_

- [ ] 8. パス機能のE2Eテストを実装する
- [ ] 8.1 パスボタンUIインタラクションのE2Eテストを追加する
  - ユーザが有効な手がない状況でパスボタンをクリックするシナリオをテストする
  - ターンがAIに切り替わることを検証する
  - パス通知が表示されることを検証する
  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.3_

- [ ] 8.2 連続パスによるゲーム終了のE2Eテストを追加する
  - 両プレイヤーが連続してパスし、ゲームが終了するシナリオをテストする
  - ゲーム結果が正しく表示されることを検証する
  - 勝者判定が正しく実行されることを検証する
  - _Requirements: 4.1, 4.4_

- [ ] 8.3 パスボタン無効化状態のE2Eテストを追加する
  - 有効な手が存在する場合、パスボタンが無効化されていることをテストする
  - `aria-disabled`属性が正しく設定されていることを検証する
  - ボタンが視覚的に無効状態で表示されることを検証する
  - 無効ボタンのクリックが無視されることを検証する
  - _Requirements: 2.2, 2.3, 2.5, 7.3_

- [ ] 8.4 パスボタンアクセシビリティのE2Eテストを追加する
  - キーボードでパスボタンにフォーカスできることをテストする
  - フォーカスインジケータが表示されることを検証する
  - `aria-label`属性が設定されていることを検証する
  - Enterキーでボタンを操作できることをテストする
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 8.5 モバイルタッチターゲットのE2Eテストを追加する
  - モバイルビューポート(375px幅)でボタンサイズが44x44px以上であることをテストする
  - タッチシミュレーションでボタンをタップできることをテストする
  - パス操作が正しく実行されることを検証する
  - _Requirements: 1.4, 6.4_

- [ ] 9. パフォーマンスとカバレッジ検証を実施する
- [ ] 9.1 パス操作のパフォーマンステストを実施する
  - パスボタンクリックから視覚的フィードバックまでの時間を測定する(目標: 100ms以内)
  - `handlePass`実行からゲーム状態更新までの時間を測定する(目標: 50ms以内)
  - Performance APIまたはReact Profilerを使用して測定する
  - _Requirements: NFR Performance 1, NFR Performance 2_

- [ ] 9.2 テストカバレッジを検証する
  - パス機能全体のコードカバレッジを測定する(目標: 90%以上)
  - ユニットテストのカバレッジレポートを生成する
  - カバレッジが不足している箇所を特定し、テストを追加する
  - _Requirements: NFR Maintainability 2_
