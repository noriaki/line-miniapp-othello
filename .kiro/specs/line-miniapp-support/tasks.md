# 実装計画

## 1. プロジェクトセットアップとLIFF SDK導入

- [x] 1.1 LIFF SDKパッケージの追加と基盤構築
  - LIFF SDKの最新安定版をプロジェクトに追加
  - パッケージマネージャーで依存関係を解決し、TypeScript型定義を確認
  - 環境変数テンプレートファイルを作成し、LIFF ID設定例を記載
  - バージョン管理システムから環境変数ファイルを除外する設定を確認
  - _Requirements: 1.1, 1.2, 1.3, 2.5_

- [ ] 1.2 環境変数管理の実装
  - 開発環境用の環境変数ファイルにLIFF ID設定を追加
  - Next.jsのクライアント公開環境変数として正しく読み込まれることを確認
  - 本番環境デプロイ時の環境変数設定方法をドキュメント化
  - 環境変数未設定時の警告処理を準備
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

## 2. LIFF統合レイヤーの型定義基盤

- [ ] 2.1 LIFF関連型定義の集約実装
  - 全LIFF関連型を一箇所にまとめた型定義ファイルを作成
  - LINEプロフィール情報を表現する型を定義
  - LIFF統合全体のコンテキスト型を定義
  - LIFF APIラッパーの公開インターフェース型を定義
  - 既存のゲームロジック型定義パターンと整合性を保つ
  - 循環依存を完全に回避する単一方向の依存構造を確立
  - _Requirements: 11.1, 11.2, 11.3_

## 3. LIFF APIラッパーとコンテキスト実装

- [x] 3.1 LIFF API操作を抽象化するクライアントの実装
  - LIFF SDKの低レベルAPIを型安全にラップするモジュールを作成
  - LIFF初期化処理を実行し、エラーを適切に返却する機能を実装
  - LINEアプリ内実行判定とログイン状態確認機能を提供
  - ログイン・ログアウト処理のインターフェースを実装
  - プロフィール情報取得機能を実装
  - TypeScript strict modeに完全準拠した型定義を適用
  - _Requirements: 1.3, 3.1, 3.2, 4.1, 4.2, 4.3, 11.1, 11.2_

- [x] 3.2 React Context定義の作成
  - LIFF状態を共有するためのReact Contextを定義
  - 型定義を外部ファイルからインポートして循環依存を回避
  - コンテキストのデフォルト値として初期状態を設定
  - _Requirements: 8.1, 8.2, 11.3_

- [x] 3.3 LIFFプロバイダーコンポーネントの実装
  - クライアントサイド専用のProviderコンポーネントを作成
  - アプリケーション起動時にLIFF SDKを初期化
  - LIFF ID環境変数が未設定の場合は警告を表示し機能を無効化
  - 初期化成功時にログイン状態とプロフィール情報を自動取得
  - プロフィール取得失敗時もエラー状態を記録しつつデフォルト表示を保証
  - 初期化失敗時はフォールバックモードでゲーム継続を可能にする
  - LINEアプリ内実行時は自動的にプロフィール取得を試行
  - Next.js Static Export互換性を維持するためのClient Component指定
  - _Requirements: 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 10.1, 10.2, 10.3, 10.5, 12.1, 12.2_

- [x] 3.4 LIFF状態アクセス用カスタムフックの作成
  - LIFFコンテキストへのアクセスを提供するカスタムフックを実装
  - Provider外で使用された場合に明確なエラーメッセージを投げる
  - 既存のゲーム状態管理フックと同様のパターンを踏襲
  - _Requirements: 8.1, 8.2_

## 4. UIコンポーネントへのLIFF機能統合

- [x] 4.1 プロフィールアイコン表示機能の追加
  - ゲームボードコンポーネントにLIFF状態アクセスフックを統合
  - プレーヤースコア表示エリアにプロフィールアイコン表示領域を追加
  - プロフィール画像URLが取得できた場合はLINEアイコンを表示
  - 画像読み込み失敗時またはプロフィール未取得時はデフォルトアイコンを表示
  - プロフィール画像をゲームUIに適した形状で表示
  - 画像エラー時のフォールバック処理を実装
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 10.2_

- [x] 4.2 外部ブラウザ用ログインUI実装
  - 外部ブラウザかつ未ログイン時にログインボタンを表示
  - ボタンクリック時にLIFFログインフローを開始
  - ログインせずにゲームプレイ継続を可能にする
  - ログイン成功後にプロフィール情報を自動的に表示
  - ネットワークエラー時のリトライまたは継続プレイ選択肢を提供
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 10.4_

- [x] 4.3 ログイン状態に応じたUI更新機能
  - ログイン済み状態ではプロフィール情報（アイコン、表示名）を表示
  - 未ログイン状態ではプレースホルダーUIを表示
  - ログイン状態変化時に関連UIを自動更新
  - LIFF初期化中は初期化状態を視覚的に表示
  - ログアウト時は状態をクリアしUIを未ログイン状態に戻す
  - _Requirements: 3.5, 8.2, 8.3, 8.4, 8.5_

## 5. アプリケーションレイアウトへのProvider統合

- [x] 5.1 グローバルレイアウトへのLiffProvider追加
  - アプリケーションルートレイアウトにLiffProviderをインポート
  - 既存のエラーバウンダリ構造を維持しつつProviderを追加
  - 全ページでLIFF機能を利用可能にする
  - Server ComponentとClient Componentの境界を明確に保つ
  - Static Export互換性を確認
  - _Requirements: 12.1, 12.3, 12.4_

## 6. エラーハンドリングとフォールバック機能

- [x] 6.1 LIFF初期化エラーの処理実装
  - LIFF初期化失敗時にユーザー向けフレンドリーメッセージを表示
  - エラー詳細を開発者コンソールに出力
  - LIFF機能なしでゲームを正常に動作させる
  - エラー状態を管理しUIに反映
  - 既存のゲームエラーハンドリングとは分離してLIFF専用処理を実装
  - _Requirements: 3.3, 10.1, 10.3_

- [x] 6.2 プロフィール取得エラーの処理実装
  - プロフィール情報取得失敗時もエラー状態を記録
  - エラー記録後もデフォルトアイコン表示を保証
  - エラー内容を開発者コンソールにログ出力
  - ゲームプレイを継続可能な状態を維持
  - LIFF機能自体は有効状態を保つ
  - _Requirements: 7.4, 7.6, 10.2_

- [x] 6.3 環境変数未設定時のフォールバック処理
  - LIFF ID環境変数が未設定の場合に警告をコンソール表示
  - LIFF機能を無効化し通常モードでゲームを起動
  - ユーザーにはLIFF機能なしで通常プレイを提供
  - _Requirements: 2.2, 10.5_

## 7. TypeScript型安全性とビルド検証

- [x] 7.1 TypeScript型定義の整備と検証
  - LIFF SDK型定義を活用したインターフェース定義を確認
  - ログイン状態を型安全に管理する仕組みを検証
  - LIFF API呼び出しの返り値型が正しく推論されることを確認
  - 型エラーがコンパイル時に検出されることを確認
  - 型定義ファイルが循環依存なく参照されることを検証
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [x] 7.2 Next.js Static Exportビルドの検証
  - ビルドコマンドで静的エクスポートが正常に生成されることを確認
  - LIFF SDKコードがクライアントバンドルのみに含まれることを確認
  - Server ComponentsでLIFF SDKを参照していないことを確認
  - 生成された静的ファイルが正常に動作することを確認
  - _Requirements: 12.1, 12.2, 12.3, 12.4_

## 8. テスト基盤とドキュメント整備

- [x] 8.1 LIFF統合のテストモック設定
  - テストフレームワークでLIFF SDKのモック実装を追加
  - LIFF APIメソッドをモック関数として定義
  - LIFF統合コードをカバレッジ計算対象から除外する設定
  - テスト実行時にLIFF関連テストをスキップまたはモック化
  - _Requirements: 9.1, 9.2, 9.3, 9.4_

- [x] 8.2 UIコンポーネントのテスト追加
  - ゲームボードコンポーネントのプロフィールアイコン表示をテスト
  - デフォルトアイコン表示のテストケースを追加
  - ログインボタンの表示・非表示ロジックをテスト
  - LIFFフックのエラーハンドリングをテスト
  - _Requirements: 9.1, 9.2_

- [x] 8.3 実装ドキュメントの更新
  - LINEミニアプリ対応の実装手順をドキュメント化
  - LIFF ID環境変数の設定方法を記載
  - トラブルシューティングガイドを作成
  - 新規ファイル構成の説明を追加（型定義集約、エラーハンドリング分離）
  - ローカル開発環境でのLIFF機能テスト方法を記載
  - _Requirements: 全要件の実装完了確認_
